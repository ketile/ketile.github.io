<!DOCTYPE html>
    <head>
        <title>BLE TEST</title>
    </head>
    
    <body>
        <div id="status"><h4>Disconnected</h4></div>
        
          <button id="btn-connect">Connect</button>
          <button id="btn-disconnect">Disconnect</button>
          <button id="btn-reconnect">Reconnect</button>
          <br><br>  
            <select id="characteristics">
                <option selected disabled>Characteristics</option>
                <option value="temperature">temperature</option>
                <option value="pressure">pressure</option>
                <option value="humidity">humidity</option>
                <option value="gas-air-quality">gas-air-quality</option>
                <option value="color">color</option>
                <option value="button">button</option>
                <option value="tap">tap</option>
                <option value="orientation">orientation</option>
                <option value="quaternion">quaternion</option>
                <option value="pedometer">pedometer</option>
                <option value="raw-motion-data">raw-motion-data</option>
                <option value="euler">euler</option>
                <option value="rotation-matrix">rotation-matrix</option>
                <option value="heading">heading</option>
                <option value="gravity-vector">gravity-vector</option>            
            </select>
            <button id="btn-test">Test Notification</button>
        
        <script src="utils.js"></script>
        <script src="ble.js"></script>
        
        <script>
            document.querySelector('#btn-connect').addEventListener('click', bleConnect);
            document.querySelector('#btn-disconnect').addEventListener('click', bleDisconnect);
            document.querySelector('#btn-reconnect').addEventListener('click', bleReconnect);
            document.querySelector('#btn-test').addEventListener('click', bleTest);
            
            function bleConnect(){
                if (!navigator.bluetooth) 
                {
                  alert('> Web Bluetooth API is not available.\n' +
                      '  Please make sure the Web Bluetooth\n' +
                      '  flag is enabled.');
                  return;
                }

                log('> Requesting Bluetooth Device...');

                navigator.bluetooth.requestDevice({
                    filters: [
                        {services: [configurationServiceUUID] }
                    ],
                        optionalServices: [weatherStationServiceUUID, userInterfaceServiceUUID, motionServiceUUID]                                             
                }) 
                
                .then(device => {
                    bleDevice = device;
                    log('  BLE Device OK');
                    log('> Name:             ' + bleDevice.name);
                    log('> ID:               ' + bleDevice.id);
                    log('> Allowed Services: ' + bleDevice.uuids.join('\n' + ' '.repeat(20)));
                    log('> Connected:        ' + bleDevice.gatt.connected); 
                    // add event listener in case of device disconnect
                    bleDevice.addEventListener('gattserverdisconnected', onDisconnected);
                    document.querySelector('#status').innerHTML = "Connected";
                    return device.gatt.connect();
                })
                
                .then(server => {
                  bleServer = server;
                  log('  BLE Server OK');
                  return bleServer.getPrimaryService(configurationServiceUUID);
                })
                
                .then(service => {
                  log('  BLE Configuration Service OK');
                  bleConfigurationService = service;
                })
                
                .then(() => {
                  return bleServer.getPrimaryService(weatherStationServiceUUID);
                })
                
                .then(service => {
                  log('  BLE Weather Station Service OK');
                  bleWeatherStationService = service;
                })
                
                .then(() => {
                  return bleServer.getPrimaryService(userInterfaceServiceUUID);
                })
                
                .then(service => {
                  log('  BLE User Interface Service OK');
                  bleUserInterfaceService = service;
                }) 
                
                .then(() => {
                  return bleServer.getPrimaryService(motionServiceUUID);
                })
                
                .then(service => {
                  log('  BLE Weather Station Service OK');
                  bleMotionService = service;
                })  
                
                .catch(error => {
                  log('> Error: ' + error);
                });
            }                

            function onDisconnected(event) {
                // Object event.target is Bluetooth Device getting disconnected.
                log('> Bluetooth Device disconnected');
                document.querySelector('#status').innerHTML = "Disconnected";
            }
            
            function bleDisconnect(){
                if (!bluetoothDevice) {
                    return;
                }
                log('> Disconnecting from Bluetooth Device...');
                document.querySelector('#status').innerHTML = "Disconnecting";
                if (bleDevice.gatt.connected) 
                {
                    bleDevice.gatt.disconnect();
                }  
                else 
                {
                    document.querySelector('#status').innerHTML = "Disconnected";
                    log('> Bluetooth Device is already disconnected');
                }
            }
            
            function bleReconnect(){
                
            }
            
            function bleTest(){
                
            }
            
            
        </script>
    </body>
</html>