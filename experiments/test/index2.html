<!DOCTYPE html>
    <head>
        <title>BLE TEST</title>
    </head>
    
    <body>
        <div id="status">Disconnected</div>
        <br>
        
          <button id="btn-connect">Connect</button>
          <button id="btn-disconnect">Disconnect</button>
          <button id="btn-reconnect">Reconnect</button>
          <br><br>  
            <select id="characteristics">
                <option selected disabled>Characteristics</option>
                <option value="temperatureCharacteristic">temperature</option>
                <option value="pressureCharacteristic">pressure</option>
                <option value="humidityCharacteristic">humidity</option>
                <option value="gasCharacteristic">gas-air-quality</option>
                <option value="colorCharacteristic">color</option>
                <option value="buttonCharacteristic">button</option>
                <option value="tapCharacteristic">tap</option>
                <option value="orientationCharacteristic">orientation</option>
                <option value="quaternionCharacteristic">quaternion</option>
                <option value="pedometeCharacteristicr">pedometer</option>
                <option value="rawDataCharacteristic">raw-motion-data</option>
                <option value="eulerCharacteristic">euler</option>
                <option value="rotationMatrixCharacteristic">rotation-matrix</option>
                <option value="headingCharacteristic">heading</option>
                <option value="gravity-vectorCharacteristic">gravity-vector</option>            
            </select>
            <button id="btn-test">Test Notification</button>
        
        <script src="utils.js"></script>
        <script src="ble.js"></script>
        
        <script>
            document.querySelector('#btn-connect').addEventListener('click', bleConnect);
            document.querySelector('#btn-disconnect').addEventListener('click', bleDisconnect);
            document.querySelector('#btn-reconnect').addEventListener('click', bleReconnect);
            document.querySelector('#btn-test').addEventListener('click', bleTestCharacteristicNotification);
            
            function bleConnect(){
                if (!navigator.bluetooth) 
                {
                  alert('> Web Bluetooth API is not available.\n' +
                      '  Please make sure the Web Bluetooth\n' +
                      '  flag is enabled.');
                  return;
                }
                document.querySelector('#status').innerHTML = "Connecting";
                log('> Requesting Bluetooth Device...');

                navigator.bluetooth.requestDevice({
                    filters: [
                        {services: [configurationServiceUUID] }
                    ],
                        optionalServices: [weatherStationServiceUUID, userInterfaceServiceUUID, motionServiceUUID]                                             
                }) 
                
                .then(device => {
                    bleDevice = device;
                    log('  BLE Device OK');
                    log('> Name:             ' + bleDevice.name);
                    log('> ID:               ' + bleDevice.id);
                    log('> Allowed Services: ' + bleDevice.uuids.join('\n' + ' '.repeat(20)));
                    log('> Connected:        ' + bleDevice.gatt.connected); 
                    // add event listener in case of device disconnect
                    bleDevice.addEventListener('gattserverdisconnected', onDisconnected);
                    document.querySelector('#status').innerHTML = "Connected";
                    return device.gatt.connect();
                })
                
                .then(server => {
                  bleServer = server;
                  log('  BLE Server OK');
                  return bleServer.getPrimaryService(configurationServiceUUID);
                })
                
                .then(service => {
                  log('  BLE Configuration Service OK');
                  bleConfigurationService = service;
                })
                
                .then(() => {
                  return bleServer.getPrimaryService(weatherStationServiceUUID);
                })
                
                .then(service => {
                  log('  BLE Weather Station Service OK');
                  bleWeatherStationService = service;
                })
                
                .then(() => {
                  return bleServer.getPrimaryService(userInterfaceServiceUUID);
                })
                
                .then(service => {
                  log('  BLE User Interface Service OK');
                  bleUserInterfaceService = service;
                }) 
                
                .then(() => {
                  return bleServer.getPrimaryService(motionServiceUUID);
                })
                
                .then(service => {
                  log('  BLE Weather Station Service OK');
                  bleMotionService = service;
                })
                
                .then(() => {
                    bleRegisterCharacteristics();
                })
                
                .catch(error => {
                  log('> Error: ' + error);
                });
            }
            
            // Test characteristics
            function bleRegisterCharacteristics(){

             bleConfigurationService.getCharacteristic(deviceNameUUID)
              .then(characteristic => {
                  deviceNameCharacteristic = characteristic;
                 log(' ');
                  log('  Device Name Characteristic OK');
                  logProperties(characteristic);
              })
            .then(() => {
                return bleConfigurationService.getCharacteristic(advertisingParametersUUID);
             })
             .then(characteristic => {
                 advertisingParametersCharacteristic = characteristic;
                 log('  Advertising Parameters Characteristic OK');
                 logProperties(characteristic);
             })
             .then(() => {
                  return bleConfigurationService.getCharacteristic(appearanceUUID);
              })
              .then(characteristic => {
                  appearanceCharacteristic = characteristic;
                  log('  Appearance Characteristic OK');
                  logProperties(characteristic);
              })
             .then(() => {
                  return bleConfigurationService.getCharacteristic(connectionParametersUUID);
              })
              .then(characteristic => {
                  connectionParametersCharacteristic = characteristic;
                  log('  Connection Parameters Characteristic OK');
                  logProperties(characteristic);                 
              })
             .then(() => {
                  return bleConfigurationService.getCharacteristic(eddystoneUrlUUID);
              })
              .then(characteristic => {
                  eddystoneUrlCharacteristic = characteristic;
                  log('  Eddystone URL Characteristic OK');
                  logProperties(characteristic);                 
              })
             .then(() => {
                  return bleConfigurationService.getCharacteristic(cloudTokenUUID);
              })
              .then(characteristic => {
                  cloudTokenCharacteristic = characteristic;
                  log('  Cloud Token Characteristic OK');
                  logProperties(characteristic);                 
              })
             .then(() => {
                  return bleWeatherStationService.getCharacteristic(temperatureUUID);
              })
              .then(characteristic => {
                  temperatureCharacteristic = characteristic;
                  log('  Temperature Characteristic OK');
                  logProperties(characteristic);                 
              })
             .then(() => {
                  return bleWeatherStationService.getCharacteristic(pressureUUID);
              })
              .then(characteristic => {
                  pressureCharacteristic = characteristic;
                  log('  Pressure Characteristic OK');
                  logProperties(characteristic);                 
              })
             .then(() => {
                  return bleWeatherStationService.getCharacteristic(humidityUUID);
              })
              .then(characteristic => {
                  humidityCharacteristic = characteristic;
                  log('  Humidity Characteristic OK');
                  logProperties(characteristic);                 
              })     
             .then(() => {
                  return bleWeatherStationService.getCharacteristic(gasUUID);
              })
              .then(characteristic => {
                  gasCharacteristic = characteristic;
                  log('  Gas Characteristic OK');
                  logProperties(characteristic);                 
              }) 
             .then(() => {
                  return bleWeatherStationService.getCharacteristic(colorUUID);
              })
              .then(characteristic => {
                  colorCharacteristic = characteristic;
                  log('  Color Characteristic OK');
                  logProperties(characteristic);                 
              }) 
             .then(() => {
                  return bleWeatherStationService.getCharacteristic(weatherConfigurationUUID);
              })
              .then(characteristic => {
                  weatherConfigurationCharacteristic = characteristic;
                  log('  Weather Configuration Characteristic OK');
                  logProperties(characteristic);                 
              }) 
             .then(() => {
                  return bleUserInterfaceService.getCharacteristic(ledUUID);
              })
              .then(characteristic => {
                  ledCharacteristic = characteristic;
                  log('  LED Characteristic OK');
                  logProperties(characteristic);                 
              }) 
             .then(() => {
                  return bleUserInterfaceService.getCharacteristic(buttonUUID);
              })
              .then(characteristic => {
                  buttonCharacteristic = characteristic;
                  log('  Button Characteristic OK');
                  logProperties(characteristic);                 
              }) 
             .then(() => {
                  return bleMotionService.getCharacteristic(motionConfigurationUUID);
              })
              .then(characteristic => {
                  motionConfigurationCharacteristic = characteristic;
                  log('  Motion Configuration Characteristic OK');
                  logProperties(characteristic);                 
              }) 
             .then(() => {
                  return bleMotionService.getCharacteristic(tapUUID);
              })
              .then(characteristic => {
                  tapCharacteristic = characteristic;
                  log('  Tap Characteristic OK');
                  logProperties(characteristic);                 
              }) 
             .then(() => {
                  return bleMotionService.getCharacteristic(orientationUUID);
              })
              .then(characteristic => {
                  orientationCharacteristic = characteristic;
                  log('  Orientation Characteristic OK');
                  logProperties(characteristic);                 
              })    
             .then(() => {
                  return bleMotionService.getCharacteristic(quaternionUUID);
              })
              .then(characteristic => {
                  quaternionCharacteristic = characteristic;
                  log('  Quaternion Characteristic OK');
                  logProperties(characteristic);                 
              })   
             .then(() => {
                  return bleMotionService.getCharacteristic(pedometerUUID);
              })
              .then(characteristic => {
                  pedometerCharacteristic = characteristic;
                  log('  Pedometer Characteristic OK');
                  logProperties(characteristic);                 
              })   
             .then(() => {
                  return bleMotionService.getCharacteristic(rawDataUUID);
              })
              .then(characteristic => {
                  rawDataCharacteristic = characteristic;
                  log('  Raw Motion Data Characteristic OK');
                  logProperties(characteristic);                 
              })   
             .then(() => {
                  return bleMotionService.getCharacteristic(eulerUUID);
              })
              .then(characteristic => {
                  eulerCharacteristic = characteristic;
                  log('  Euler Characteristic OK');
                  logProperties(characteristic);                 
              })   
             .then(() => {
                  return bleMotionService.getCharacteristic(rotationMatrixUUID);
              })
              .then(characteristic => {
                  rotationMatrixCharacteristic = characteristic;
                  log('  Rotation Matrix Characteristic OK');
                  logProperties(characteristic);                 
              })   
             .then(() => {
                  return bleMotionService.getCharacteristic(headingUUID);
              })
              .then(characteristic => {
                  headingCharacteristic = characteristic;
                  log('  Heading Characteristic OK');
                  logProperties(characteristic);                 
              })   
             .then(() => {
                  return bleMotionService.getCharacteristic(gravityVectorUUID);
              })
              .then(characteristic => {
                  gravityVectorCharacteristic = characteristic;
                  log('  Gravity Vector Characteristic OK');
                  logProperties(characteristic);                 
              })
             .then(() => {
                 // add all characteristic objects to array for easy use
                 addAllCharacteristics();
             })
             .then(() => {
                 // add event listeners for characteristics with notification enabled
                 addEventListeners();
             })
              .catch(error => {
                  log('> Error: ' + error);
              });
            }            

            function onDisconnected(event) {
                // Object event.target is Bluetooth Device getting disconnected.
                log('> Bluetooth Device disconnected');
                document.querySelector('#status').innerHTML = "Disconnected";
            }
            
            function bleDisconnect(){
                if (!bleDevice) {
                    return;
                }
                log('> Disconnecting from Bluetooth Device...');
                document.querySelector('#status').innerHTML = "Disconnecting";
                if (bleDevice.gatt.connected) 
                {
                    bleDevice.gatt.disconnect();
                }  
                else 
                {
                    document.querySelector('#status').innerHTML = "Disconnected";
                    log('> Bluetooth Device is already disconnected');
                }
            }
            
            function addAllCharacteristics(){
                allCharacteristics = [
                            deviceNameCharacteristic,
                            advertisingParametersCharacteristic,
                            appearanceCharacteristic,
                            connectionParametersCharacteristic,
                            eddystoneUrlCharacteristic,
                            cloudTokenCharacteristic,
                            temperatureCharacteristic,
                            pressureCharacteristic,
                            humidityCharacteristic,
                            gasCharacteristic,
                            colorCharacteristic,
                            weatherConfigurationCharacteristic,
                            ledCharacteristic,
                            buttonCharacteristic,
                            motionConfigurationCharacteristic,
                            tapCharacteristic,
                            orientationCharacteristic,
                            quaternionCharacteristic,
                            pedometerCharacteristic,
                            rawDataCharacteristic,
                            eulerCharacteristic,
                            rotationMatrixCharacteristic,
                            headingCharacteristic,
                            gravityVectorCharacteristic
                            ];
            }    
            
            function addEventListeners(){
                
                addEventListener('temperature', temperatureCharacteristic, temperatureNotificationEventHandler);
                
                addEventListener('pressure', pressureCharacteristic, pressureNotificationEventHandler);
                addEventListener('humidity', humidityCharacteristic, humidityNotificationEventHandler);
                addEventListener('gas', gasCharacteristic, gasNotificationEventHandler);
                addEventListener('color', colorCharacteristic, colorNotificationEventHandler);
                addEventListener('button', buttonCharacteristic, buttonNotificationEventHandler);
                addEventListener('tap', tapCharacteristic,tapNotificationEventHandler);
                addEventListener('orientation', orientationCharacteristic, orientationNotificationEventHandler);
                addEventListener('quaternion', quaternionCharacteristic, quaternionNotificationEventHandler);
                addEventListener('pedometer', pedometerCharacteristic, pedometerNotificationEventHandler);
                addEventListener('raw data', rawDataCharacteristic, rawDataNotificationEventHandler);
                addEventListener('euler', eulerCharacteristic, eulerNotificationEventHandler);
                addEventListener('rotation matrix', rotationMatrixCharacteristic, rotationMatrixNotificationEventHandler);
                addEventListener('heading', headingCharacteristic, headingNotificationEventHandler);
                addEventListener('gravity vector', gravityVectorCharacteristic, gravityVectorNotificationEventHandler);
            }
            
            function addEventListener(name, characteristic, handler){
               characteristic.addEventListener('characteristicvaluechanged', handler);                
               log(' Added ' + name + ' event listener');
            }
            
            function bleReconnect(){
                
            }
            
            function bleTestCharacteristicNotification(){
                // Stop last notification
                if(lastNotification){
                    lastNotification.stopNotifications();
                }               
                var fnString = document.querySelector("#characteristics").value;
                var fn = window[fnString];
                log('> You selected: ' + fnString);
                // run the selected function
                fn.startNotifications();
                lastNotification = fn;
            }
            
            function temperatureNotificationEventHandler(event){
                logRawHexValues(event);
            }
            
            function pressureNotificationEventHandler(event){
                logRawHexValues(event);
            }
            
            function humidityNotificationEventHandler(event){
                logRawHexValues(event);
            } 
            
            function gasNotificationEventHandler(event){
                logRawHexValues(event);
            }
            
            function colorNotificationEventHandler(event){
                logRawHexValues(event);
            }   
            
            function buttonNotificationEventHandler(event){
                logRawHexValues(event);
            }   
            
            function tapNotificationEventHandler(event){
                logRawHexValues(event);
            }  
            
            function orientationNotificationEventHandler(event){
                logRawHexValues(event);
            }                
            
            function quaternionNotificationEventHandler(event){
                logRawHexValues(event);
            }   
            
            function pedometerNotificationEventHandler(event){
                logRawHexValues(event);
            }     
            
            function rawDataNotificationEventHandler(event){
                logRawHexValues(event);
            }    
            
            function eulerNotificationEventHandler(event){
                logRawHexValues(event);
            }    
            
            function rotationMatrixNotificationEventHandler(event){
                logRawHexValues(event);
            }  
            
            function headingNotificationEventHandler(event){
                logRawHexValues(event);
            }    
            
            function gravityVectorNotificationEventHandler(event){
                logRawHexValues(event);
            }                
            
            
        </script>
    </body>
</html>